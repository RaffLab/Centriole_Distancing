

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>models &mdash; Centriole Distancing 0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Centriole Distancing
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Centriole Distancing</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>models</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for models</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python2</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains functions to aid in the building of the CNN architecture used by us in the paper</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    
<div class="viewcode-block" id="distance_model"><a class="viewcode-back" href="../models.html#models.distance_model">[docs]</a><span class="k">def</span> <span class="nf">distance_model</span><span class="p">(</span><span class="n">n_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">N_Cls</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Builds the CNN U-net model described in paper in Keras to learn centriole distancing on local image patches.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_channels : int</span>
<span class="sd">        number of input image channels.</span>
<span class="sd">    shape : None or 3-tuple</span>
<span class="sd">        (n_rows x n_cols x n_channel) assuming tensorflow format. If None, the model is fully convolutional and can be applied to any size input.</span>
<span class="sd">    N_Cls : int</span>
<span class="sd">        number of output channels, should equal the number of channels in annotations.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model : a Keras Model class</span>
<span class="sd">        CNN model instance. Use model.summary() to get a print out of architecture.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">keras.layers</span> <span class="k">import</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">MaxPooling2D</span><span class="p">,</span> <span class="n">merge</span>

    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ISZ</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">Input</span><span class="p">((</span><span class="n">ISZ</span><span class="p">,</span> <span class="n">ISZ</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># down-pooling branch</span>
    <span class="n">conv1</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;selu&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="n">conv1</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;selu&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">conv1</span><span class="p">)</span>    
    <span class="n">pool1</span> <span class="o">=</span> <span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">conv1</span><span class="p">)</span>

    <span class="n">conv2</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;selu&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">pool1</span><span class="p">)</span>
    <span class="n">conv2</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;selu&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">conv2</span><span class="p">)</span>

    <span class="c1"># up-pooling branch</span>
    <span class="n">up1</span> <span class="o">=</span> <span class="n">merge</span><span class="p">([</span><span class="n">UpSampling2D</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">conv2</span><span class="p">),</span> <span class="n">conv1</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;concat&#39;</span><span class="p">,</span> <span class="n">concat_axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">conv3</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;selu&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">up1</span><span class="p">)</span>
    <span class="n">conv3</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;selu&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">conv3</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">N_Cls</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">conv3</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="train_model"><a class="viewcode-back" href="../models.html#models.train_model">[docs]</a><span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">early_stop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_history</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Code to train a given model and save out to the designated path as given by &#39;model_name&#39;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    train_data : 2-tuple</span>
<span class="sd">        (train_x, train_y) where train_x is the images and train_y is the Gaussian dot annotation images in the train split.</span>
<span class="sd">    test_data : 2-tuple</span>
<span class="sd">        (test_x, test_y) where test_x is the images and test_y is the Gaussian dot annotation images in the test split.</span>
<span class="sd">    model : a Keras model</span>
<span class="sd">        a defined Keras model</span>
<span class="sd">    optimizer : Keras optimizer object</span>
<span class="sd">        the gradient descent optimizer e.g. Adam, SGD instance used to optimizer the model. We used Adam() with default settings.</span>
<span class="sd">    loss : string </span>
<span class="sd">        one of &#39;mse&#39; (mean squared error) or &#39;mae&#39; (mean absolute error)</span>
<span class="sd">    scale_factor : None or float</span>
<span class="sd">        multiplicative factor to apply to annotation images to increase the gradient in the backpropagation</span>
<span class="sd">    batch_size : int</span>
<span class="sd">        number of images to batch together for training </span>
<span class="sd">    max_epochs : int</span>
<span class="sd">        the maximum number of epochs to train for if early_stop is enabled else this is the number of epochs of training.</span>
<span class="sd">    early_stop : bool</span>
<span class="sd">        if True, monitors the minimum of the test loss. If loss does not continue to decrease for a set duration, stop the training and return the model with the best test loss.</span>
<span class="sd">    plot_hist : bool</span>
<span class="sd">        if True, plots the training and test loss over the training period on the same axes for visualisation.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None : void</span>
<span class="sd">        This function will simply save the model to the location given by model_name.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">keras.optimizers</span> <span class="k">import</span> <span class="n">Adam</span>
    <span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="k">import</span> <span class="n">EarlyStopping</span><span class="p">,</span> <span class="n">ModelCheckpoint</span>
    <span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">plt</span> 
    
    <span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span> <span class="o">=</span> <span class="n">train_data</span>
    <span class="n">test_x</span><span class="p">,</span> <span class="n">test_y</span> <span class="o">=</span> <span class="n">test_data</span>

    <span class="k">if</span> <span class="n">scale_factor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">train_y</span> <span class="o">=</span> <span class="n">train_y</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">)</span>
        <span class="n">test_y</span> <span class="o">=</span> <span class="n">test_y</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">)</span>

    <span class="c1"># compile the model with chosen optimizer.</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span> 
    
    <span class="k">if</span> <span class="n">early_stop</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Set some early stopping parameters &quot;&quot;&quot;</span>
        <span class="n">early_stop</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> 
                                <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> 
                                <span class="n">patience</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> 
                                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> 
                                <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> 
                                    <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> 
                                    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                    <span class="n">save_best_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> 
                                    <span class="n">period</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">test_x</span><span class="p">,</span> <span class="n">test_y</span><span class="p">),</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">early_stop</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">test_x</span><span class="p">,</span> <span class="n">test_y</span><span class="p">),</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span> <span class="c1"># save the whole model state.</span>
    
    <span class="k">if</span> <span class="n">plot_history</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;train loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">[]</span></div>


<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
    <span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">plt</span> 
    <span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>
    <span class="kn">from</span> <span class="nn">keras.models</span> <span class="k">import</span> <span class="n">Model</span>
    <span class="kn">from</span> <span class="nn">keras.layers</span> <span class="k">import</span> <span class="n">Input</span><span class="p">,</span> <span class="n">merge</span><span class="p">,</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">MaxPooling2D</span><span class="p">,</span> <span class="n">UpSampling2D</span><span class="p">,</span> <span class="n">Reshape</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Concatenate</span><span class="p">,</span> <span class="n">BatchNormalization</span><span class="p">,</span> <span class="n">Activation</span>
    <span class="kn">from</span> <span class="nn">keras.optimizers</span> <span class="k">import</span> <span class="n">Adam</span>
    <span class="kn">from</span> <span class="nn">scipy.misc</span> <span class="k">import</span> <span class="n">imsave</span> 
    <span class="kn">import</span> <span class="nn">os</span> 
    <span class="kn">import</span> <span class="nn">cv2</span>
    <span class="kn">from</span> <span class="nn">skimage.exposure</span> <span class="k">import</span> <span class="n">rescale_intensity</span>
    <span class="kn">from</span> <span class="nn">skimage.filters</span> <span class="k">import</span> <span class="n">sobel</span>
    <span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">spio</span> 
    
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1674</span><span class="p">)</span>
    
<span class="c1">#==============================================================================</span>
<span class="c1">#   Load the train-test_data</span>
<span class="c1">#==============================================================================</span>
    
    <span class="n">in_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Training_Testing_patches_sectioned-Early.mat&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Training_Testing_patches_sectioned-Mid.mat&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Training_Testing_patches_sectioned-Late.mat&#39;</span><span class="p">]</span>

<span class="c1">###==============================================================================</span>
<span class="c1">###   Distort samples .. </span>
<span class="c1">###==============================================================================</span>
    <span class="n">stage</span> <span class="o">=</span> <span class="s1">&#39;Early&#39;</span>
<span class="c1">#    # Load up the single model first. </span>
<span class="c1">#    (X_train,Y_train,D_train), (X_test,Y_test,D_test) = compile_train_test_data(in_files, typ=&#39;single&#39;, which=0)</span>
<span class="c1">#    </span>
<span class="c1">#    X_train = X_train / 255.</span>
<span class="c1">#    </span>
<span class="c1">####==============================================================================</span>
<span class="c1">####   Apply Deformations</span>
<span class="c1">####==============================================================================</span>
<span class="c1">#    train_x, train_y = apply_elastic_transform_intensity_multi(X_train/255., Y_train, strength=0.2, shift=0, N=50) # can try to use strength lower. </span>
<span class="c1">#    train_x, train_y_dots = create_dot_annotations_multi(train_x, train_y, sigma=2, thresh=0) # turn into dots. </span>
<span class="c1">#    </span>
<span class="c1">#    test_x, test_y_dots = create_dot_annotations_multi(X_test/255., Y_test, sigma=2, thresh=0) # turn into dots. </span>
<span class="c1">#    </span>
<span class="c1">##     do we deform also ? -&gt; hm..... no?? </span>
<span class="c1">##    X_test = X_test / 255.</span>
<span class="c1">##    test_x, test_y_dots = create_dot_annotations_multi(X_test, Y_test, sigma=2, thresh=0)</span>
<span class="c1">##    test_x = rescale_intensity_stack(test_x)</span>
<span class="c1">#    </span>
<span class="c1">#    </span>
<span class="c1">#    # try saving the data</span>
<span class="c1">#    spio.savemat(&#39;pooled_augmented_train-test-compress-%s.mat&#39; %(stage), {&#39;X_train&#39;:train_x,</span>
<span class="c1">#                                                     &#39;Y_train_dots&#39;:train_y_dots, </span>
<span class="c1">#                                                     &#39;X_test&#39;:test_x,</span>
<span class="c1">#                                                     &#39;Y_test_dots&#39;:test_y_dots}, do_compression=True)</span>
    
    
    
    <span class="c1"># too noisy for validaton -&gt; augment the test data too !.</span>
<span class="c1">#    test_x, test_y = apply_elastic_transform_intensity_multi(X_test/255., Y_test, strength=0.2, shift=0, N=50) # can try to use strength lower. </span>
<span class="c1">#    test_x, test_y_dots = create_dot_annotations_multi(test_x, test_y, sigma=2, thresh=0) # turn into dots. </span>
<span class="c1">#    </span>
<span class="c1">#    </span>
<span class="c1">#    train_x = train_x[:,:,:,None]</span>
<span class="c1">#    train_y_dots = train_y_dots[:,:,:,None]</span>
<span class="c1">#    test_x = test_x[:,:,:,None]</span>
<span class="c1">#    test_y = test_y_dots[:,:,:,None]</span>
    <span class="n">train_test_data</span> <span class="o">=</span> <span class="n">spio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="s1">&#39;pooled_augmented_train-test-compress-</span><span class="si">%s</span><span class="s1">.mat&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">stage</span><span class="p">))</span>
    
    <span class="n">train_x</span> <span class="o">=</span> <span class="n">train_test_data</span><span class="p">[</span><span class="s1">&#39;X_train&#39;</span><span class="p">]</span>
    <span class="n">train_y_dots</span> <span class="o">=</span> <span class="n">train_test_data</span><span class="p">[</span><span class="s1">&#39;Y_train_dots&#39;</span><span class="p">]</span>
    <span class="n">test_x</span> <span class="o">=</span> <span class="n">train_test_data</span><span class="p">[</span><span class="s1">&#39;X_test&#39;</span><span class="p">]</span>
    <span class="n">test_y_dots</span> <span class="o">=</span> <span class="n">train_test_data</span><span class="p">[</span><span class="s1">&#39;Y_test_dots&#39;</span><span class="p">]</span>
    
    <span class="n">train_x</span> <span class="o">=</span> <span class="n">train_x</span><span class="p">[:,:,:,</span><span class="kc">None</span><span class="p">]</span>
    <span class="n">train_y_dots</span> <span class="o">=</span> <span class="n">train_y_dots</span><span class="p">[:,:,:,</span><span class="kc">None</span><span class="p">]</span>
    <span class="n">test_x</span> <span class="o">=</span> <span class="n">test_x</span><span class="p">[:,:,:,</span><span class="kc">None</span><span class="p">]</span>
    <span class="n">test_y</span> <span class="o">=</span> <span class="n">test_y_dots</span><span class="p">[:,:,:,</span><span class="kc">None</span><span class="p">]</span>
    
    <span class="c1">#==============================================================================</span>
    <span class="c1">#    U-net Model Construction.  </span>
    <span class="c1">#==============================================================================</span>
    <span class="c1"># save out and construct a FCNN....(probably need a scale transform)</span>
    <span class="n">ISZ</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">N_Cls</span> <span class="o">=</span> <span class="mi">2</span>
    
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">Input</span><span class="p">((</span><span class="n">ISZ</span><span class="p">,</span> <span class="n">ISZ</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">conv1</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;selu&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="n">conv1</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;selu&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">conv1</span><span class="p">)</span>
    
<span class="c1">#    # replace to get batch normalization </span>
<span class="c1">#    conv1 = Conv2D(32, (3, 3), padding=&#39;same&#39;)(inputs)</span>
<span class="c1">#    conv1 = BatchNormalization()(conv1)</span>
<span class="c1">#    conv1 = Activation(&#39;selu&#39;)(conv1)</span>
<span class="c1">#    conv1 = Conv2D(32, (3, 3), padding=&#39;same&#39;)(conv1)</span>
<span class="c1">#    conv1 = BatchNormalization()(conv1)</span>
<span class="c1">#    conv1 = Activation(&#39;selu&#39;)(conv1)</span>
    
    <span class="n">pool1</span> <span class="o">=</span> <span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">conv1</span><span class="p">)</span>

    <span class="n">conv2</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;selu&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">pool1</span><span class="p">)</span>
    <span class="n">conv2</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;selu&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">conv2</span><span class="p">)</span>
    
<span class="c1">#    conv2 = Conv2D(64, (3, 3), padding=&#39;same&#39;)(pool1)</span>
<span class="c1">#    conv2 = BatchNormalization()(conv2)</span>
<span class="c1">#    conv2 = Activation(&#39;selu&#39;)(conv2)</span>
<span class="c1">#    conv2 = Conv2D(64, (3, 3), padding=&#39;same&#39;)(conv2)</span>
<span class="c1">#    conv2 = BatchNormalization()(conv2)</span>
<span class="c1">#    conv2 = Activation(&#39;selu&#39;)(conv2)</span>
    
<span class="c1">#    pool2 = MaxPooling2D(pool_size=(2, 2))(conv2)</span>
<span class="c1">##    conv3 = Conv2D(128, (3, 3), activation=&#39;selu&#39;, padding=&#39;same&#39;)(pool2)</span>
<span class="c1">##    conv3 = Conv2D(128, (3, 3), activation=&#39;selu&#39;, padding=&#39;same&#39;)(conv3)</span>
<span class="c1">#    </span>
<span class="c1">##    conv3 = Conv2D(64, (3, 3), padding=&#39;same&#39;)(pool2)</span>
<span class="c1">##    conv3 = BatchNormalization()(conv3)</span>
<span class="c1">##    conv3 = Activation(&#39;relu&#39;)(conv3)</span>
<span class="c1">##    conv3 = Conv2D(64, (3, 3), padding=&#39;same&#39;)(conv3)</span>
<span class="c1">##    conv3 = BatchNormalization()(conv3)</span>
<span class="c1">##    conv3 = Activation(&#39;relu&#39;)(conv3)</span>
<span class="c1">#    </span>
<span class="c1">#    conv3 = Conv2D(128, (3, 3), activation=&#39;selu&#39;, padding=&#39;same&#39;)(pool2)</span>
<span class="c1">#    conv3 = Conv2D(128, (3, 3), activation=&#39;selu&#39;, padding=&#39;same&#39;)(conv3)</span>
<span class="c1">#    pool3 = MaxPooling2D(pool_size=(2, 2))(conv3)</span>
<span class="c1">##</span>
<span class="c1">##    conv4 = Conv2D(72, (3, 3), activation=&#39;relu&#39;, padding=&#39;same&#39;)(pool3)</span>
<span class="c1">##    conv4 = Conv2D(72, (3, 3), activation=&#39;relu&#39;, padding=&#39;same&#39;)(conv4)</span>
<span class="c1">##    pool4 = MaxPooling2D(pool_size=(2, 2))(conv4)</span>
<span class="c1">##    </span>
<span class="c1">##    conv5 = Conv2D(72, (3, 3), activation=&#39;relu&#39;, padding=&#39;same&#39;)(pool4)</span>
<span class="c1">##    conv5 = Conv2D(72, (3, 3), activation=&#39;relu&#39;, padding=&#39;same&#39;)(conv5)</span>
<span class="c1">##    pool5 = MaxPooling2D(pool_size=(2, 2))(conv5)</span>
<span class="c1">###</span>
<span class="c1">##    conv6 = Conv2D(90, (3, 3), activation=&#39;relu&#39;, padding=&#39;same&#39;)(pool5)</span>
<span class="c1">##    conv6 = Conv2D(90, (3, 3), activation=&#39;relu&#39;, padding=&#39;same&#39;)(conv6)</span>
<span class="c1">##</span>
<span class="c1">##    up7 = merge([UpSampling2D(size=(2, 2))(conv6), conv5], mode=&#39;concat&#39;, concat_axis=-1)</span>
<span class="c1">##    conv7 = Conv2D(72, (3, 3), activation=&#39;relu&#39;, padding =&#39;same&#39;)(up7)</span>
<span class="c1">##    conv7 = Conv2D(72, (3, 3), activation=&#39;relu&#39;, padding =&#39;same&#39;)(conv7)</span>
<span class="c1">##</span>
<span class="c1">#    up8 = merge([UpSampling2D(size=(2, 2))(conv3), conv2], mode=&#39;concat&#39;, concat_axis=-1)</span>
<span class="c1">#    up8 = Concatenate(axis=-1)([UpSampling2D(size=(2, 2))(conv3), conv2])</span>
<span class="c1">#    conv8 = Conv2D(64, (3, 3), activation=&#39;selu&#39;, padding=&#39;same&#39;)(up8)</span>
<span class="c1">#    conv8 = Conv2D(64, (3, 3), activation=&#39;selu&#39;, padding=&#39;same&#39;)(conv8)</span>
<span class="c1">#</span>
<span class="c1">#    up9 = merge([UpSampling2D(size=(2, 2))(conv8), conv3], mode=&#39;concat&#39;, concat_axis=-1)</span>
<span class="c1">#    up9 = Concatenate(axis=-1)([UpSampling2D(size=(2, 2))(conv2), conv1])</span>
<span class="c1">#    conv9 = Conv2D(32, (3, 3), activation=&#39;selu&#39;, padding=&#39;same&#39;)(up9)</span>
<span class="c1">#    conv9 = Conv2D(32, (3, 3), activation=&#39;selu&#39;, padding=&#39;same&#39;)(conv9)</span>
<span class="c1">#</span>
    <span class="n">up10</span> <span class="o">=</span> <span class="n">merge</span><span class="p">([</span><span class="n">UpSampling2D</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">conv2</span><span class="p">),</span> <span class="n">conv1</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;concat&#39;</span><span class="p">,</span> <span class="n">concat_axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">conv10</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;selu&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">up10</span><span class="p">)</span>
    <span class="n">conv10</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;selu&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">conv10</span><span class="p">)</span>
<span class="c1">#    </span>
<span class="c1">#    up11 = merge([UpSampling2D(size=(2, 2))(conv10), conv1], mode=&#39;concat&#39;, concat_axis=-1)</span>
<span class="c1">#    conv11 = Conv2D(32, (3, 3), activation=&#39;relu&#39;, padding=&#39;same&#39;)(up11)</span>
<span class="c1">#    conv11 = Conv2D(32, (3, 3), activation=&#39;relu&#39;, padding=&#39;same&#39;)(conv11)</span>
<span class="c1">#    conv10 = merge([conv9, inputs], mode=&#39;concat&#39;, concat_axis=-1)</span>
<span class="c1">#    up10 = merge([inputs, conv9], mode=&#39;concat&#39;, concat_axis=-1) # also feed in the original image as well as the upsampled. </span>
    <span class="n">conv12</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">N_Cls</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">conv10</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">conv12</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(),</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span> <span class="c1"># avoid over detection ?</span>

    <span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

    
    <span class="c1">#==============================================================================</span>
    <span class="c1">#   Model Fitting with Early Stopping.   </span>
    <span class="c1">#==============================================================================</span>
    <span class="kn">from</span> <span class="nn">keras.optimizers</span> <span class="k">import</span> <span class="n">Adam</span>
    <span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="k">import</span> <span class="n">EarlyStopping</span><span class="p">,</span> <span class="n">ModelCheckpoint</span>
    

    <span class="n">train_y_dots</span> <span class="o">=</span> <span class="n">train_y_dots</span><span class="o">*</span> <span class="mf">1000.</span>
    <span class="n">test_y_dots</span> <span class="o">=</span> <span class="n">test_y_dots</span> <span class="o">*</span> <span class="mf">1000.</span>
    
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="mi">200</span>
    
<span class="c1">#        &quot;&quot;&quot; Set some early stopping parameters &quot;&quot;&quot;</span>
    <span class="n">early_stop</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> 
                               <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> 
                               <span class="n">patience</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> 
                               <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> 
                               <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="s1">&#39;Multi-S1_32x32_selu_all_sigma2_mse-</span><span class="si">%s</span><span class="s1">-notestaug&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">stage</span><span class="p">),</span> 
                                 <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> 
                                 <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                 <span class="n">save_best_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                 <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> 
                                 <span class="n">period</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># single model</span>
<span class="c1">#    history = model.fit(train_x, train_y_dots[:,:,:,0,0][:,:,:,None],</span>
<span class="c1">#              batch_size=batch_size,</span>
<span class="c1">#              epochs=epochs,</span>
<span class="c1">#              validation_data=(test_x, test_y_dots[:,:,:,0][:,:,:,None]), shuffle=True, </span>
<span class="c1">#              callbacks = [early_stop, checkpoint])</span>
    
    <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y_dots</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">],</span>
              <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
              <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
              <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">test_x</span><span class="p">,</span> <span class="n">test_y_dots</span><span class="p">),</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
              <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">early_stop</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">])</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
<span class="c1">#        </span>
<span class="c1">#####        </span>
<span class="c1">######### =============================================================================</span>
<span class="c1">#########   test</span>
<span class="c1">######### =============================================================================</span>
<span class="c1">#######</span>
<span class="c1">###    </span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_x</span><span class="p">))[:</span><span class="mi">10</span><span class="p">]:</span>
        
<span class="c1">#        imm = X_test[i]/255.</span>
        <span class="n">imm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">test_x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">imm</span> <span class="o">=</span> <span class="n">rescale_intensity</span><span class="p">(</span><span class="n">imm</span><span class="p">)</span>
<span class="c1">#        imm = equalize_adapthist((imm/255.)[:,:,0], clip_limit=0.01)[:,:,None]</span>
<span class="c1">#        imm = imm /255.</span>
        
        <span class="n">out</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">imm</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:,</span><span class="kc">None</span><span class="p">])</span><span class="o">/</span><span class="mf">1000.</span>
        
<span class="c1">#        plt.figure()</span>
<span class="c1">#        plt.subplot(121)</span>
<span class="c1">#        plt.imshow(np.squeeze(imm), cmap=&#39;gray&#39;)</span>
<span class="c1">#        plt.subplot(122)</span>
<span class="c1">#        plt.imshow(np.squeeze(out))</span>
<span class="c1">#        plt.show()</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">imm</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">out</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">out</span><span class="p">[:,:,:,</span><span class="mi">1</span><span class="p">]))</span>
<span class="c1">#        plt.subplot(154)</span>
<span class="c1">#        plt.imshow(np.squeeze(out))</span>
<span class="c1">#        plt.subplot(155)</span>
<span class="c1">#        plt.imshow(Y_test[i][:,:,1])</span>
<span class="c1">#        plt.show()</span>
        
        <span class="nb">print</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
<span class="c1">#    </span>
<span class="c1">#    </span>
<span class="c1">#    </span>
<span class="c1">#    </span>
    

        
        
        
        
        
    
    
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Felix Y. Zhou

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'0.1',
              LANGUAGE:'en',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: ''
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>